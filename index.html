<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FILIAL ATCD – Corretoras</title>
<style>
:root{ --brand:#2c50bb; --bg:#f6f8ff; --card:#ffffff; --ink:#121826; --muted:#6b7280; --radius:16px; --shadow:0 10px 25px rgba(18,24,38,.08); }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e5e7eb}
.bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px}
.left,.right{display:flex;gap:8px;align-items:center} h1{font-size:18px;margin:0;display:flex;gap:10px;align-items:center}
.badge{background:var(--brand);color:#fff;border-radius:999px;padding:6px 10px;font-weight:600}
.logo{height:28px;width:auto;cursor:pointer}
input[type=search],select,button,.btn{border:1px solid #d1d5db;background:#fff;border-radius:12px;padding:10px 12px}
button.primary{background:var(--brand);color:#fff;border-color:transparent;box-shadow:var(--shadow)}
.wrap{padding:18px} .columns{display:grid;gap:16px;grid-template-columns:repeat(4,minmax(260px,1fr))}
.col{background:#fff;border:1px solid #e5e7eb;border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:60vh}
.col-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eef2ff}
.col-title{font-weight:700;display:flex;align-items:center;gap:8px}.col-count{background:#eef2ff;color:var(--brand);padding:4px 8px;border-radius:999px;font-weight:700}
.col-body{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:200px}
.card{background:var(--card);border:1px solid #eef2ff;border-radius:14px;padding:12px;box-shadow:var(--shadow)}
.login-wrap{position:fixed;inset:0;background:linear-gradient(180deg,#eef2ff,#ffffff);display:none;place-items:center;z-index:50}
.login-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow);width:min(420px,92vw);padding:18px;display:flex;flex-direction:column;gap:12px}
.muted{color:#6b7280;font-size:12px}.login-logo{height:38px;width:auto;display:block;margin:0 auto 6px auto}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="left">
      <img id="appLogo" src="" alt="BP" class="logo" title="Clique para alterar a logo" />
      <input id="logoInput" type="file" accept="image/*" style="display:none" />
      <h1>FILIAL ATCD <span class="badge">Corretoras</span></h1>
    </div>
    <div class="right">
      <button class="primary" id="btnAdd">+ Novo atendimento</button>
      <button id="btnUsers" style="display:none">Usuários</button>
      <button id="btnLogout">Sair</button>
    </div>
  </div>
</header>
<div class="wrap"><div id="board" class="columns"></div></div>

<div class="login-wrap" id="loginWrap">
  <div class="login-card">
    <img id="loginLogo" class="login-logo" alt="Logo" />
    <h2>Entrar</h2>
    <div class="field"><label for="l_email">E-mail</label><input id="l_email" type="email" /></div>
    <div class="field"><label for="l_senha">Senha</label><input id="l_senha" type="password" /></div>
    <button id="btnLogin" class="primary" type="button">Entrar</button>
    <p class="muted">Primeiro crie um usuário na tabela 'usuarios' do Neon e defina uma senha_hash com bcrypt.</p>
  </div>
</div>

<script>
const TOKEN_KEY='kanban_auth_token_v1';
const $=s=>document.querySelector(s);
function setToken(t){ localStorage.setItem(TOKEN_KEY, t||''); }
function getToken(){ return localStorage.getItem(TOKEN_KEY)||''; }
function showLogin(b){ $('#loginWrap').style.display=b?'grid':'none'; }

async function api(path, opts={}){
  const headers=Object.assign({'Content-Type':'application/json'}, opts.headers||{});
  const tok=getToken(); if(tok) headers['Authorization']='Bearer '+tok;
  const r=await fetch(path, Object.assign({},opts,{headers}));
  const text=await r.text();
  try{ return JSON.parse(text); }catch{ return { ok:false, raw:text }; }
}

async function checkSession(){
  const tok=getToken(); if(!tok){ showLogin(true); return; }
  const r=await api('/.netlify/functions/auth_me');
  if(r?.ok){ window.session=r.user; showLogin(false); loadAll(); } else { setToken(''); showLogin(true); }
}

document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const email=$('#l_email').value.trim(); const senha=$('#l_senha').value;
  const r=await api('/.netlify/functions/auth_login',{ method:'POST', body: JSON.stringify({ email, senha }) });
  if(!r?.ok){ alert('Credenciais inválidas'); return; }
  setToken(r.token); window.session=r.user; showLogin(false); loadAll();
});

document.getElementById('btnLogout').addEventListener('click', async ()=>{
  await api('/.netlify/functions/auth_logout',{ method:'POST' }); setToken(''); window.session=null; showLogin(true);
});

async function loadLogo(){
  const r=await api('/.netlify/functions/settings_get?key=logo_data_url');
  if(r?.value){ $('#appLogo').src=r.value; $('#loginLogo').src=r.value; $('#loginLogo').style.display='block'; }
}
$('#appLogo').addEventListener('click', ()=> $('#logoInput').click());
$('#logoInput').addEventListener('change', async ev=>{
  const f=ev.target.files?.[0]; if(!f) return;
  if(window.session?.perfil!=='admin'){ alert('Somente admin pode alterar a logo.'); ev.target.value=''; return; }
  const reader=new FileReader(); reader.onload=async ()=>{
    await api('/.netlify/functions/settings_set',{ method:'POST', body: JSON.stringify({ key:'logo_data_url', value: reader.result }) });
    await loadLogo(); ev.target.value='';
  }; reader.readAsDataURL(f);
});

async function loadAll(){
  await loadLogo();
  const r=await api('/.netlify/functions/atendimentos_list');
  const items=r?.rows||[];
  const cols=[{key:'novo',title:'Novo'},{key:'andamento',title:'Em andamento'},{key:'aguardando',title:'Aguardando retorno'},{key:'concluido',title:'Concluído'}];
  const board=$('#board'); board.innerHTML='';
  for(const col of cols){
    const sec=document.createElement('section'); sec.className='col';
    sec.innerHTML=`<div class="col-header"><div class="col-title">${col.title} <span class="col-count">${items.filter(i=>i.status===col.key).length}</span></div></div><div class="col-body"></div>`;
    const body=sec.querySelector('.col-body');
    items.filter(i=>i.status===col.key).forEach(it=>{
      const el=document.createElement('article'); el.className='card';
      el.innerHTML=`<h4>${it.assunto}</h4><div>${it.corretora} — ${it.prioridade}</div>`;
      body.appendChild(el);
    });
    board.appendChild(sec);
  }
}

document.addEventListener('DOMContentLoaded', checkSession);
</script>
</body>
</html>
